using System;
using System.IO;
using NUnit.Framework;

namespace Electrolyte.Test {
	[TestFixture]
	public class VersionMessageTest {
		[Test]
		public void TestVersionInfo() {
			byte[] bytes = {
				0xF9, 0xBE, 0xB4, 0xD9,													// Magic
				0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, // Message ("version     ")
				0x64, 0x00, 0x00, 0x00,													// Payload length (100 bytes)
				0x35, 0x8D, 0x49, 0x32,													// Payload checksum

				0x62, 0xEA, 0x00, 0x00,																																		// Version 60002
				0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,																												// Services.NodeNetwork
				0x11, 0xB2, 0xD0, 0x50, 0x00, 0x00, 0x00, 0x00,																												// 2012 Dec 18 05:12:33 UTC
				0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	// Recipient
				0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // Sender
				0x3B, 0x2E, 0xB3, 0x5D, 0x8C, 0xE6, 0x17, 0x65,																												// Random unique ID (nonce)
				0x0F, 0x2F, 0x53, 0x61, 0x74, 0x6F, 0x73, 0x68, 0x69, 0x3A, 0x30, 0x2E, 0x37, 0x2E, 0x32, 0x2F,																			// User-agent ("/Satoshi:0.7.2/")
				0xC0, 0x3E, 0x03, 0x00																																		// Latest block height (#212672)
			};

			using(BinaryReader reader = new BinaryReader(new MemoryStream(bytes))) {
				VersionMessage version = new VersionMessage(reader);

				Assert.AreEqual(version.Version, 60002);
				Assert.AreEqual(version.AvailableServices, VersionMessage.Services.NodeNetwork);
				Assert.AreEqual(version.Time, new DateTime(2012, 12, 18, 18, 12, 33, DateTimeKind.Utc));
				Assert.AreEqual(version.UserAgent, "/Satoshi:0.7.2/");
				Assert.AreEqual(version.BlockHeight, 212672);
			}
		}
	}
}

